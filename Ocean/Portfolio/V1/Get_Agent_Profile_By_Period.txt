APUI00_03_Get_Agent_Profile_By_Period
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Feb 08, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล Agent Profile ตาม agent code และ period ที่ได้รับมา
 

Process Overview
ดึงข้อมูล Agent Profile ในฐานข้อมูล ตาม agent code (รับมาจากการ Login หรือ รับมาจากการ click มาจาก link อื่น) และ period ที่ได้รับมาจาก Process : APUI00_01_Get_Current_Period
 

Preconditions
รับค่า agent code และ period เข้ามา
 

Process Description
      ในกรณีที่ Login เข้าใช้งานครั้งแรก จะมีการตรวจสอบก่อนว่า Agent รายนั้น ๆ มีตำแหน่งสูงสุด คือ ตำแหน่งใด โดยจะทำการตรวจสอบตามขั้นตอนตั้งแต่ ข้อ 1., 2., 3. และ 4. ก็จะทำให้ได้ข้อมูล Agent Profile รายนั้น ๆ แต่ถ้าเป็นการ click มาจาก link อื่น จะทำให้ทราบอยู่แล้วว่า Agent รายนั้น ๆ อยู่ในตำแหน่งใด ก็ให้เลือกขั้นตอนการดึงข้อมูล Agent Profile ตามตำแหน่งได้เลย

 

ตรวจสอบว่า agent code และ period ที่ได้รับมานั้น ใช่ Agent ที่อยู่ในตำแหน่ง "ผจภ.สข." หรือไม่ ?
- ถ้าได้ null ให้ทำข้อ 2. ต่อไป
- ถ้าได้ค่าออกมา ก็ไม่ต้องทำต่อข้อ 2. และจะทำให้ทราบว่า agent code นี้อยู่ในตำแหน่ง "ผจภ.สข." ใน period นี้ 

Icon
select	branch_code, branch_name, 
		headmn_code_7 as agent_code_7, headmn_name as agent_name, 
		'ผจภ.สข.' :: varchar as position_group, 
		coalesce(position, 'ผจภ.สข.' :: varchar) as position -- >> [corrected by AGPT-22]
from		agpt_agent_income
where	period = v_period -- รับค่า period มา เช่น '2560/14' เป็นต้น
	and	branch_code = v_branch_code -- รับค่า branch code มา เช่น '3208' เป็นต้น
	and	headmn_code_7 = v_agent_code -- รับค่า agent code มา เช่น '5000946' เป็นต้น
	and	headmn_code_7 = agent_code_7; -- >> [corrected by AGPT-22]
     

 [SQL Not Used : Old Version]
     

ตรวจสอบว่า agent code และ period ที่ได้รับมานั้น ใช่ Agent ที่อยู่ในตำแหน่ง "ผจก.หน่วย" หรือไม่ ?
- ถ้าได้ null ให้ทำข้อ 3. ต่อไป
- ถ้าได้ค่าออกมา ก็ไม่ต้องทำต่อข้อ 3. และจะทำให้ทราบว่า agent code นี้อยู่ในตำแหน่ง "ผจก.หน่วย" ใน period นี้ 

Icon
select	branch_code, branch_name, 
		manager_code_7 as agent_code_7, manager_name as agent_name, 
		'ผจก.หน่วย' :: varchar as position_group, 
		case 
			when headmn_code_7 = manager_code_7 then 'ผู้จัดการหน่วย' :: varchar 
			else coalesce(position, 'ผู้จัดการหน่วย' :: varchar) 
		end as position -- >> [corrected by AGPT-22]
from		agpt_agent_income
where	period = v_period
	and branch_code = v_branch_code
	and	manager_code_7 = v_agent_code
	and	headmn_code_7 = v_agent_code_parent -- เพิ่มการ check parent ด้วยว่ามี parent เป็นคนนี้จริง เพื่อป้องกันตอน pen test (กันช่องโหว่ของ hacker)
	and	manager_code_7 = agent_code_7; -- >> [corrected by AGPT-22]
     

 [SQL Not Used : Old Version]
     

[Phase 2 - add] ตรวจสอบว่า agent code และ period ที่ได้รับมานั้น ใช่ Agent ที่อยู่ในตำแหน่ง "ผช.ผจก.หน่วย" หรือไม่ ?
- ถ้าได้ null ให้ทำข้อ 4. ต่อไป
- ถ้าได้ค่าออกมา ก็ไม่ต้องทำต่อข้อ 4. และจะทำให้ทราบว่า agent code นี้อยู่ในตำแหน่ง "ผจก.หน่วย" ใน period นี้ 

Icon
select	branch_code, branch_name, 
		asst_manager_code_7, asst_manager_name, 
		'ผช.ผจก.หน่วย' :: varchar as position_group, 
		case 
			when headmn_code_7 = asst_manager_code_7 then 'ผู้ช่วยผู้จัดการหน่วย' :: varchar 
			else coalesce(position, 'ผู้ช่วยผู้จัดการหน่วย' :: varchar) 
		end as position -- >> [corrected by AGPT-22]
from		agpt_agent_income
where	period = v_period
	and	branch_code = v_branch_code
	and	asst_manager_code_7 = v_agent_code
	and	headmn_code_7 = v_agent_code_parent -- เพิ่มการ check parent ด้วยว่ามี parent เป็นคนนี้จริง เพื่อป้องกันตอน pen test (กันช่องโหว่ของ hacker)
	and	asst_manager_code_7 = agent_code_7; -- >> [corrected by AGPT-22]
     

[Phase 2 - edit] ตรวจสอบว่า agent code และ period ที่ได้รับมานั้น ใช่ Agent ที่อยู่ในตำแหน่ง "หนน." หรือ "ตท." หรือ "ตท.กง." อย่างใดอย่างหนึ่ง หรือไม่ ?
- เมื่อได้ค่าออกมา ก็จะทำให้ทราบว่า agent code นี้อยู่ในตำแหน่ง "หนน." หรือ "ตท." หรือ "ตท.กง." อย่างใดอย่างหนึ่ง ใน period นี้ 

Icon
select	branch_code, branch_name, agent_code_7, agent_name, 
		case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หนน.' :: varchar
			else position_group
		end position_group,
		case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หัวหน้าหน่วย' :: varchar
			else position
		end as position
from		agpt_agent_income
where	period = v_period
	and branch_code = v_branch_code
	and	agent_code_7 = v_agent_code
	and	(manager_code_7 = v_agent_code_parent or asst_manager_code_7 = v_agent_code_parent); -- เพิ่มการ check parent ด้วยว่ามี parent เป็นคนนี้จริง เพื่อป้องกันตอน pen test (กันช่องโหว่ของ hacker)
     

 [SQL Not Used : Old Version]
Post-conditions
ทำการ return ข้อมูล Agent Profile ทั้งหมด 6 fields คือ 
- branch_code
- branch_name
- agent_code_7
- agent_name
- position_group
- position

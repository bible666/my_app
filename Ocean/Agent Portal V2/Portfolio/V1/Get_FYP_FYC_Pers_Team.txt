APUI05_02_Get_FYP_FYC_Pers_Team
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Feb 08, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล FYP, FYC และ Persistency รวมทีม ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล FYP, FYC และ Persistency รวมทีม ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
Icon
select	a.headmn_code_7 as agent_code_7, 
		a.fyp, a.fyc, b.headmn_persistency as persistency
from		(
			select	period, branch_code, headmn_code_7, 
					sum(premium_portfolio) as fyp, sum(commission_first) as fyc
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	headmn_code_7 = v_agent_code	
			group by	period, branch_code, headmn_code_7
		) a
left outer join	agpt_persistency_summary b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.headmn_code_7 = b.headmn_code_7		
group by	a.headmn_code_7, a.fyp, a.fyc, b.headmn_persistency;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
select	a.manager_code_7 as agent_code_7, 											-- >> [corrected by AGPT-81] Start
		a.fyp, a.fyc, b.manager_persistency as persistency
from		(
			select	period, branch_code, manager_code_7, 
					sum(premium_portfolio) as fyp, sum(commission_first) as fyc
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code	
			group by	period, branch_code, manager_code_7
		) a
left outer join	agpt_persistency_summary b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.manager_code_7 = b.manager_code_7		
group by	a.manager_code_7, a.fyp, a.fyc, b.manager_persistency;					-- >> [corrected by AGPT-81] End
     

 [SQL Not Used : Old Version]
     

[Phase 2 - add] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
select	a.asst_manager_code_7 as agent_code_7, 
		a.fyp, a.fyc, b.asst_manager_persistency as persistency
from		(
			select	period, branch_code, asst_manager_code_7, 
					sum(premium_portfolio) as fyp, sum(commission_first) as fyc
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	asst_manager_code_7 = v_agent_code	
			group by	period, branch_code, asst_manager_code_7
		) a
left outer join	agpt_persistency_summary b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.asst_manager_code_7 = b.asst_manager_code_7		
group by	a.asst_manager_code_7, a.fyp, a.fyc, b.asst_manager_persistency;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
select	b.agent_code_7 as agent_code_7, 
		b.fyp, b.fyc, c.supervisor_persistency as persistency
from		(
			select	period, branch_code, agent_code_7, sum(fyp) as fyp, sum(fyc) as fyc
			from		(
						select	period, branch_code, agent_code_7, 
								premium_portfolio as fyp, commission_first as fyc
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	agent_code_7 = v_agent_code	
						union all
						select	period, branch_code, recruiter_code_7 as agent_code_7, 
								sum(premium_portfolio) as fyp, sum(commission_first) as fyc
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	recruiter_code_7 = v_agent_code
							and	(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null)
						group by	period, branch_code, recruiter_code_7
					) a
			group by	period, branch_code, a.agent_code_7
		) b
left outer join	agpt_persistency_summary c
on		b.period = c.period
	and	b.branch_code = c.branch_code
	and	b.agent_code_7 = c.supervisor_code_7		
group by	b.agent_code_7, b.fyp, b.fyc, c.supervisor_persistency;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group in ("ตท.", "ตท.กง.") อย่างใดอย่างหนึ่ง จะ return null
 

Post-conditions
ทำการ return ข้อมูล FYP, FYC และ Persistency รวมทีม ทั้งหมด 3 fields คือ 
- fyp
- fyc
- persistency
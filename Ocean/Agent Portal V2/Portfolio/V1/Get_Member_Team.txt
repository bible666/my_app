Agent Portal…  02. Process Specification
APUI05_03_Get_Member_Team
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Feb 08, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล Member รวมทีม ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล Member รวมทีม ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
Icon
select	a.headmn_code_7 as agent_code_7, count(a.manager_code_7) as member
from		(			
			select	headmn_code_7, manager_code_7
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	headmn_code_7 = v_agent_code	
				and	(manager_code_7 <> '' and manager_code_7 is not null)
			group by	headmn_code_7, manager_code_7
			union all
			select	headmn_code_7, asst_manager_code_7 as manager_code_7
			from		agpt_agent_income
			where	period = v_period 
				and	branch_code = v_branch_code
				and	headmn_code_7 = v_agent_code
				and	((manager_code_7 is null or manager_code_7 = '') and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
			group by	headmn_code_7, asst_manager_code_7
		) a
group by	a.headmn_code_7;
     

 [SQL Not Used : Old Version]
     

[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
select	a.manager_code_7 as agent_code_7, count(a.agent_code_7) as member
from		(				
			select	manager_code_7, agent_code_7
			from		agpt_agent_income				
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	(position_group <> 'ตท.' and position_group <> 'ตท.กง.' and position_group is not null)
				and	(asst_manager_code_7 is null or asst_manager_code_7 = '')
			group by	manager_code_7, agent_code_7	
			union all -- Manager --> Agent (not have supervisor)
			select	manager_code_7, agent_code_7
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and 
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))	
				and	(asst_manager_code_7 is null or asst_manager_code_7 = '')
			union all
			select	manager_code_7, asst_manager_code_7 as agent_code_7
			from		agpt_agent_income
			where	period = v_period 
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	(manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
			group by	manager_code_7, asst_manager_code_7							
		) a
group by	a.manager_code_7;
     

 [SQL Not Used : Old Version]
     

[Phase 2 - add] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
select	a.asst_manager_code_7 as agent_code_7, count(a.agent_code_7) as member
from		(				
			select	asst_manager_code_7, agent_code_7
			from		agpt_agent_income				
			where	period = v_period
				and	branch_code = v_branch_code
				and	asst_manager_code_7 = v_agent_code
				and	(position_group <> 'ตท.' and position_group <> 'ตท.กง.' and position_group is not null)
			group by	asst_manager_code_7, agent_code_7	
			union all -- Manager --> Agent (not have supervisor)
			select	asst_manager_code_7, agent_code_7
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	asst_manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and -- >> [corrected by AGPT-34]
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))								
		) a
group by	a.asst_manager_code_7;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
select	a.recruiter_code_7 as agent_code_7, count(a.agent_code_7) as member
from		(				
			select	recruiter_code_7, agent_code_7
			from		agpt_agent_income				
			where	period = v_period
				and	branch_code = v_branch_code
				and	recruiter_code_7 = v_agent_code
				and	(position_group = 'ตท.' or position_group = 'ตท.กง.')
			group by	recruiter_code_7, agent_code_7									
		) a
group by	a.recruiter_code_7;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group in ("ตท.", "ตท.กง.") อย่างใดอย่างหนึ่ง จะ return null
 

Post-conditions
ทำการ return ข้อมูล Member รวมทีม ทั้งหมด 2 fields คือ 
- agent_code_7
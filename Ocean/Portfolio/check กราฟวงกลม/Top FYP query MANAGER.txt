-- MANAGER("ผจก.หน่วย","ผู้จัดการหน่วย","manager_code_7","umn")
select agent_name as agentName, agent_code_7 as agentCode7, premium_portfolio as premiumPortfolio, position_group as positionGroup,position    
                   from    
                   (    
                   select agent_name, agent_code_7, premium_portfolio,   
                    case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หนน.'    
                    else position_group    
                    end position_group,   
                    case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หัวหน้าหน่วย'    
                    else position    
                    end as position    
                   from (   
                    select agent_code_7, agent_name, premium_portfolio, position_group, position,   
                    ROW_NUMBER () OVER (ORDER BY premium_portfolio desc, agent_code_7) as row_number   
                    from (   
                    select c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.premium_portfolio + c.sub_premium_portfolio) as premium_portfolio,   
                    c.position_group, c.position     
                    from (    
                      select a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, sum(coalesce(b.premium_portfolio,0)) as sub_premium_portfolio,   
                      a.position_group, a.position    
                    from agpt_agent_income a   
                    left outer join agpt_agent_income b   
                    on (a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and   
                    a.period = b.period and a.branch_code = b.branch_code and   
                    (b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))    
                    where a.period = :period    
                    and a.branch_code = :branchCode   
                    and a.manager_code_7 = :agentCode   
                    and (a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)   
                    and (a.asst_manager_code_7 is null or a.asst_manager_code_7 = '')   
                    group by a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, a.position_group, a.position   
                    union all   
                    select a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, 0 as sub_premium_portfolio,   
                    a.position_group, a.position    
                    from agpt_agent_income a    
                    where a.period = :period   
                    and a.branch_code = :branchCode    
                    and a.manager_code_7 = :agentCode   
                    and ((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and    
                    (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))   
                    and (asst_manager_code_7 is null or asst_manager_code_7 = '')     + 
                      union all  + 
                      select    asst_manager_code_7 as agent_code_7, asst_manager_name as agent_name,   + 
                            null as recruiter_code_7, sum(premium_portfolio) as premium_portfolio, 0 as sub_premium_portfolio,  + 
                            'ผช.ผจก.หน่วย'  as position_group, 'ผู้ช่วยผู้จัดการหน่วย'  as position  + 
                      from      agpt_agent_income  + 
                      where period = :period   + 
                        and branch_code = :branchCode  + 
                        and manager_code_7 = :agentCode  + 
                        and (manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))  + 
                      group by  asst_manager_code_7, asst_manager_name   
                    ) c    
                    ) aa     
                    ) bb    
                   where bb.row_number <= 5     
                   union all   
                   select 'คนอื่นๆ รวมกัน'  as manager_name,    
                    null as manager_code_7,   
                    sum(premium_portfolio) as premium_portfolio,     
                    null as position_group, null as position   
                   from (    
                    select agent_code_7, agent_name, premium_portfolio, position_group, position,   
                    ROW_NUMBER () OVER (ORDER BY premium_portfolio desc, agent_code_7) as row_number   
                    from (   
                    select c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.premium_portfolio + c.sub_premium_portfolio) as premium_portfolio,   
                    c.position_group, c.position     
                    from (    
                      select a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, sum(coalesce(b.premium_portfolio,0)) as sub_premium_portfolio,   
                      a.position_group, a.position    
                    from agpt_agent_income a   
                    left outer join agpt_agent_income b   
                    on (a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and   
                    (b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))    
                    where a.period = :period    
                    and a.branch_code = :branchCode   
                    and a.manager_code_7 = :agentCode   
                    and (a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)   
                    and (a.asst_manager_code_7 is null or a.asst_manager_code_7 = '')   
                    group by a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, a.position_group, a.position   
                    union all   
                    select a.agent_code_7, a.agent_name, a.recruiter_code_7, a.premium_portfolio, 0 as sub_premium_portfolio,   
                    a.position_group, a.position    
                    from agpt_agent_income a    
                    where a.period = :period   
                    and a.branch_code = :branchCode    
                    and a.manager_code_7 = :agentCode   
                    and ((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and    
                    (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))   +
                      union all  + 
                      select    asst_manager_code_7 as agent_code_7, asst_manager_name as agent_name,   + 
                            null as recruiter_code_7, sum(premium_portfolio) as premium_portfolio, 0 as sub_premium_portfolio,  + 
                            'ผช.ผจก.หน่วย'  as position_group, 'ผู้ช่วยผู้จัดการหน่วย'  as position  + 
                      from      agpt_agent_income  + 
                      where period = :period   + 
                        and branch_code = :branchCode  + 
                        and manager_code_7 = :agentCode  + 
                        and (manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))  + 
                      group by  asst_manager_code_7, asst_manager_name   
                    ) c    
                    ) aa     
                    ) bb    
                   where bb.row_number > 5    
                   ) cc   
                   where cc.premium_portfolio is not null

APUI12_05_Get_Commission_by_Position_Group
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on May 30, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูลเกี่ยวกับ key และ value เกี่ยวกับ Commission ในฐานข้อมูล Lookup ตาม FYC ของแต่ละระดับตำแหน่ง และ period ที่ได้รับมา
 

Process Overview
ดึงข้อมูลเกี่ยวกับ key และ value เกี่ยวกับ Commission ในฐานข้อมูล Lookup ตาม FYC ของแต่ละระดับตำแหน่ง และ period ที่ได้รับมา
 

Preconditions
รับค่า fyc, position_group, position_level และ period เข้ามา
 

Process Description
ถ้า fyc ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (จากนั้นให้ทำต่อข้อ 2.)
Icon
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_supervisor'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from		lookup_data
where	key_group = 'commission_supervisor'
	and	key <= fyc -- เช่น 2551 เป็นต้น
group by	key_group;
     

ถ้า fyc ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (จากนั้นให้ทำต่อข้อ 3.) 
Icon
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_asst_manager'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from		lookup_data
where	key_group = 'commission_asst_manager'
	and	key <= fyc -- เช่น 2551 เป็นต้น
group by	key_group;
     

ถ้า fyc ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (จากนั้นให้ทำต่อข้อ 4.)
Icon
-- กรณี ผจก.หน่วย จะมีค่า commission 2 ส่วน คือ ส่วนของ ผจก.หน่วย เอง กับส่วนของ ผช.ผจก.หน่วย (ใช้ทั้ง 2 query)
-- SQL1 : key_group = 'commission_manager'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_manager'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_manager'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
 
-- SQL2 : key_group = 'commission_manager_asst'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_manager_asst'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_manager_asst'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
     

ถ้า fyc ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ 
Icon
-- กรณี ผจก.หน่วย จะมีค่า commission 4 ส่วน คือ ส่วนของ ผจก.หน่วย อาวุโส, ผจภ.สข. ระดับ 1, ผจภ.สข. ระดับ 2 และ ผจภ.สข. ระดับ 3 (ใช้ query อย่างใดอย่างหนึ่งเท่านั้น)


-- ถ้า position = 'ผู้จัดการหน่วยอาวุโส' ให้ใช้ SQL1 ถ้าไม่ใช่ ให้ข้ามไปใช้ SQL2
-- SQL1 : key_group = 'commission_senior_manager'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_senior_manager'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_senior_manager'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
 
 
-- ถ้า position_level is null ให้ใช้ SQL2 ถ้าไม่ใช่ ให้ข้ามไปใช้ SQL3
-- SQL2 : key_group = 'commission_head_manager1'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_head_manager1'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_head_manager1'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;


-- ถ้า position_level = '1' ให้ใช้ SQL3 ถ้าไม่ใช่ ให้ข้ามไปใช้ SQL4 
-- SQL3 : key_group = 'commission_head_manager1'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_head_manager1'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_head_manager1'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
 
-- ถ้า position_level = '2' ให้ใช้ SQL4 ถ้าไม่ใช่ ให้ข้ามไปใช้ SQL5 
-- SQL4 : key_group = 'commission_head_manager2'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_head_manager2'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_head_manager2'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
 
-- ถ้า position_level = '3' ให้ใช้ SQL5
-- SQL5 : key_group = 'commission_head_manager3'
with lookup_data as 
(	select	key_group, cast(key as numeric) as key, cast(value as numeric) as value
	from	agpt_lookup_data 		
	where	key_group = 'commission_head_manager3'
	and	period_from <= v_period_number and period_to >= v_period_number -- '256018'			
)
select	key_group, max(key) as commission, max(value) as pay_commission
from	lookup_data
where	key_group = 'commission_head_manager3'
	and	key <= fyc -- เช่น 5485 เป็นต้น
group by	key_group;
     

Post-conditions
ทำการ return ข้อมูลเกี่ยวกับ key และ value เกี่ยวกับ Commission ทั้งหมด 3 fields คือ 
- key_group
- commission
- pay_commission

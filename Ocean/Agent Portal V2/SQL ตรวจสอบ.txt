
select T1.policy_type ,tmp_group_policy_status , Group_status
     , sum(Case When T1.policy_no_400 is not null and tmp_group_policy_status = 'Active' and Group_status = 'Inactive' then 1 else 0 end )  nbs_as400
    -- ,sum(case when temp_birthdate_v21 = cust_birthdate_400 then 1 else 0 end) as birthdate_check_nbs_match_as400
     ---sum(case when temp_birthdate_v21 = cust_birthdate_400 then 1 else 0 end) as birthdate_ok_nbs_match_as400,
	--sum(case when  temp_birthdate_v21 <> cust_birthdate_400 then 1 else 0 end) as birthdate_ng_nbs_match_as400,
	
	--sum(case when  age_nbs  = age_at_comm_400    then 1 else 0 end) as age_check_nbs_match_as400,
	--sum(case when  age_nbs  = age_at_comm_400    then 1 else 0 end) as age_ok_nbs_match_as400,
     --sum(case when  age_nbs  <> age_at_comm_400   then 1 else 0 end) as age_ng_nbs_match_as400,
     
   -- sum(case when  sex_nbs = sex_400 then 1 else 0 end) as sex_check_nbs_match_as400,
    --sum(case when  sex_nbs = sex_400 then 1 else 0 end) as sex_ok_nbs_match_as400,
    -- sum(case when  sex_nbs <> sex_400  then 1 else 0 end) as sex_ng_nbs_match_as400,
   -- sum(case when not temp_commencement_date_v5~ '^[0-9\.]+$' then 0.0
       --When cast(temp_commencement_date_v5 as numeric)  = cast(commencement_date_400 as numeric)  then 1 else 0.0 end) as commendate_check_nbs_match_as400,
      
   --sum(case when  temp_commencement_date_v5  = commencement_date_400 then 1 else 0 end) as commendate_check_nbs_match_as400,
    --sum(case when  cast(temp_commencement_date_v5 as integer) = commencement_date_400 then 1 else 0 end) as commendate_ok_nbs_match_as400,
    -- sum(case when  cast(temp_commencement_date_v5 as integer) <> commencement_date_400 then 1 else 0 end) as commendate_ng_nbs_match_as400,
    
    --sum(case when not temp_maturity_date_v19a~ '^[0-9\.]+$' then 0.0
        --When cast(temp_maturity_date_v19a as numeric)  = cast(maturity_date_400 as numeric) then 1 else 0.0 end) as muturdate_check_nbs_match_as400,
        
        -- sum(case when  temp_maturity_date_v19a    = maturity_date_400  then 1 else 0 end) as muturdate_check_nbs_match_as400,
     --sum(case when  temp_maturity_date_v19a   = cast (maturity_date_400 as varchar) then 1 else 0 end) as muturdate_ok_nbs_match_as400,
    -- sum(case when  temp_maturity_date_v19a   <> cast (maturity_date_400 as varchar) then 1 else 0 end) as muturdate_ng_nbs_match_as400,
    
    -- sum(case when plan_nbs = plan_code_400 then 1 else 0 end) as plan_check_nbs_match_as400,
     --- sum(case when plan_nbs = plan_code_400 then 1 else 0 end) as plan_ok_nbs_match_as400,
    -- sum(case when plan_nbs <> plan_code_400 then 1 else 0 end) as plan_ng_nbs_match_as400,
    
  --  sum(case when  preamount_nbs = premium_amount_400 then 1 else 0 end) as preamount_check_nbs_match_as400,
     --sum(case when  preamount_nbs = premium_amount_400 then 1 else 0 end) as preamount_ok_nbs_match_as400,
     --sum(case when  preamount_nbs <> premium_amount_400 then 1 else 0 end) as preamount_ng_nbs_match_as400,
     
    -- sum(case when  sumassure_nbs = sum_assured_400 then 1 else 0 end) as sumassure_check_nbs_match_as400,
     --sum(case when  sumassure_nbs = sum_assured_400 then 1 else 0 end) as sumassure_ok_nbs_match_as400,
     --sum(case when  sumassure_nbs <> sum_assured_400 then 1 else 0 end) as sumassure_ng_nbs_match_as400,
     
       --sum(case when  lastpay_nbs = last_payment then 1 else 0 end) as lastpay_check_nbs_match_as400,
     --sum(case when  lastpay_nbs = last_payment then 1 else 0 end) as lastpay_ok_nbs_match_as400,
     --sum(case when  lastpay_nbs <> last_payment then 1 else 0 end) as lastpay_ng_nbs_match_as400,

       --sum(case when   prefix_name_v6b = cust_title_name_400 then 1 else 0 end) as prefix_check_nbs_match_as400,
     --sum(case when   prefix_name_v6b = cust_title_name_400 then 1 else 0 end) as prefix_ok_nbs_match_as400,
     --sum(case when  prefix_name_v6b <> cust_title_name_400 then 1 else 0 end) as prefix_ng_nbs_match_as400,

       --sum(case when  name_v6  = cust_name_400  then 1 else 0 end) as name_check_nbs_match_as400,
     --sum(case when  name_v6  = cust_name_400  then 1 else 0 end) as name_ok_nbs_match_as400,
    -- sum(case when  name_v6  <> cust_name_400  then 1 else 0 end) as name_ng_nbs_match_as400,

      --sum(case when  surname_v6a = cust_surname_400  then 1 else 0 end) as surname_check_nbs_match_as400,
    -- sum(case when  surname_v6a = cust_surname_400  then 1 else 0 end) as surname_ok_nbs_match_as400,
    -- sum(case when  surname_v6a <> cust_surname_400  then 1 else 0 end) as surname_ng_nbs_match_as400,

      --sum(case when  loan_status_v02 = loan_status_400  then 1 else 0 end) as loan_check_nbs_match_as400
    -- sum(case when  loan_status_v02 = loan_status_400  then 1 else 0 end) as loan_ok_nbs_match_as400,
     --sum(case when  loan_status_v02 <> loan_status_400 then 1 else 0 end) as loan_ng_nbs_match_as400
from (
select  T1.policy_no_v2 
, T2.policy_no_400
, T1.policy_type
, T2.policy_type_400
,T1.data_source as data_source_nbs
,lower(T2.data_source) as data_source_400
,T1.payment_final_v15
--,case when T1.payment_final_v15  is not NULL then cast(replace(payment_final_v15,',','')  as integer) else 0 end  lastpay_nbs
,case when T1.payment_final_v15 ~ '^[0-9\.]+$'  then cast(T1.payment_final_v15 as integer) else 0 end  lastpay_nbs
--,case when T1.payment_final_v15 is not NULL then cast(T1.payment_final_v15 as integer) else 0 end  lastpay_nbs
, T2.last_payment
, T1.policy_status_v12
,case When T1.policy_status_v12 = '4' and  62 - cast(substring(T1.payment_final_v15,1,2 ) as integer) <= 5  then 'Active'
     When T1.policy_status_v12 = '4' and  62 - cast(substring(T1.payment_final_v15,1,2) as integer) > 5 then 'Inactive'
     when T1.policy_status_v12 in ('1','2','3','6','7','10','12','13','18') then 'Active'
     when T1.policy_status_v12 in ('5','8','9','11','14','15','16','17','19','88','99','20') then 'Inactive'
     else 'Undefined' end tmp_group_policy_status
, T2.policy_status_400
, case when T2.priority in (1,2) and  T2.policy_status_400 in ('0','1','2','6','8') then 'Active' 
  when T2.priority in (1,2) and  T2.policy_status_400 = '7' and   62 - cast(substring(cast(T2.last_payment as varchar(4)) ,1,2) as integer) <= 5  then 'Active'
  when T2.priority in (1,2) and  T2.policy_status_400 = '7' and   62 - cast(substring(cast(T2.last_payment as varchar(4)) ,1,2) as integer) > 5  then 'Inactive'
  When T2.priority > 2 then 'Inactive' 
  else 'Inactive' end Group_status --, count(1) --T3.data_source ,T1.data_source as nbs_data_source ,T1.policy_status_v12 ,count(1)
--,COALESCE(lpad(branch_code_400 :: varchar ,4,'0'),'0000') 
,T1.branch_code ,lpad(branch_code_400 :: varchar ,4,'0') as branch_code_400
,T3.agent_agent7  as agent7_nbs,T2.agentcode
,T1.premium_amount_v1 
--,case when T1.premium_amount_v1  is not NULL then cast(replace(premium_amount_v1,',','')  as decimal) else 0 end  premium_nbs
,case when T1.premium_amount_v1 ~ '^[0-9\.]+$'  then cast(T1.premium_amount_v1 as decimal) else 0.0 end  preamount_nbs
--,case when T1.premium_amount_v1 is not NULL then cast(T1.premium_amount_v1 as decimal) else 0 end  preamount_nbs
,T2.premium_amount_400
,T1.plan_code_v4 
--,case when T1.plan_code_v4  is not NULL then cast(replace(plan_code_v4,',','')  as integer) else 0 end  plan_nbs
,case when T1.plan_code_v4 ~ '^[0-9\.]+$'  then cast(T1.plan_code_v4 as integer) else 0 end  plan_nbs
--,case when T1.plan_code_v4 is not NULL then cast(T1.plan_code_v4 as integer) else 0 end  plan_nbs
, T2.plan_code_400
,T1.sum_assured_v3 
,case when T1.sum_assured_v3 ~ '^[0-9\.]+$'  then cast(T1.sum_assured_v3 as decimal) else 0.0 end  sumassure_nbs
--,case when T1.sum_assured_v3  is not NULL then cast(T1.sum_assured_v3  as decimal) else 0 end  sumassure_nbs
--,case when T1.sum_assured_v3  is not NULL then cast(replace(sum_assured_v3,',','')  as decimal) else 0 end  sumassure_nbs

,T2.sum_assured_400
--,T1.loan_status_v02 
,case when T1.loan_status_v02 is NULL then '' else T1.loan_status_v02 end as loan_status_v02
,T2.loan_status_400
,case when length(replace(commencement_date_v5,'-','')) = 8 
   then substr(replace(commencement_date_v5,'-',''),5,4)||substr(replace(commencement_date_v5,'-',''),3,2)||substr(replace(commencement_date_v5,'-',''),1,2)
    when commencement_date_v5 is null then '' else commencement_date_v5  end as  temp_commencement_date_v5
--else commencement_date_v5 end as  temp_commencement_date_v5
, T2.commencement_date_400
,case when length(replace(maturity_date_v19a,'-','')) = 8 
     then substr(replace(maturity_date_v19a,'-',''),5,4)||substr(replace(maturity_date_v19a,'-',''),3,2)||substr(replace(maturity_date_v19a,'-',''),1,2)
   when maturity_date_v19a  is null then '' else maturity_date_v19a   end as  temp_maturity_date_v19a

    
      --else maturity_date_v19a end as  temp_maturity_date_v19a
, T2.maturity_date_400
,T1.sex_v10 
		,case when T1.sex_v10 is not NULL then T1.sex_v10 else '' end sex_nbs
		,T2.sex_400
		,T1.age_at_comm_date_v11
		,case when T1.age_at_comm_date_v11 ~ '^[0-9\.]+$'  then cast(T1.age_at_comm_date_v11 as integer) else 0 end  age_nbs
		--, case when T1.age_at_comm_date_v11 is not NULL then cast(T1.age_at_comm_date_v11 as integer) else 0 end age_nbs
		, T2.age_at_comm_400
, T2.custid
--, T1.prefix_name_v6b 
, case when T1.prefix_name_v6b  is  NULL then '' else T1.prefix_name_v6b end as prefix_name_v6b
, Case When  T2.title_name_400 is not null then T2.title_name_400
       when T4.mctitl  is NULL then '' else T4.mctitl  end as cust_title_name_400
--, T1.name_v6
,case when T1.name_v6  is  NULL then '' else T1.name_v6 end as name_v6
, Case When  T2.name is not null then T2.name
       when T4.mcname  is NULL then '' else T4.mcname  end as cust_name_400 
---, Case When  T2.name is not null then T2.name else T4.mcname end as cust_name_400 
--, T1.surname_v6a
,case when T1.surname_v6a  is  NULL then '' else T1.surname_v6a end as surname_v6a
, Case When  T2.surname is not null then T2.surname
       when T4.mcsurn  is NULL then '' else T4.mcsurn  end as cust_surname_400   

--, Case When  T2.surname is not null then T2.surname else T4.mcsurn end as cust_surname_400  
,case when length(replace(birthdate_v21,'-','')) = 8 
			then substr(replace(birthdate_v21,'-',''),5,4)||substr(replace(birthdate_v21,'-',''),3,2)||substr(replace(birthdate_v21,'-',''),1,2)
		when birthdate_v21 is null then '' else birthdate_v21 end as  temp_birthdate_v21
		, Case when  T4.mccsid is not null  then T4.mcbyy :: varchar || lpad(T4.mcbmm :: varchar ,2,'0') ||lpad(T4.mcbdd :: varchar ,2,'0') else '' end cust_birthdate_400
--, T1.*,T2.*,T3.agent_agent7 as agent7_nbs ,T4.*
--,T3.a19 as agent7_nbs
--select T2.*
from 
(
select  policy_no_v2
,agent5_last5filename
,policy_status_v12
,tmp_group_policy_status
,branch_code
,agent7_v8d
,tmp_agent7_v8d
,cause_code
,policy_type
--,Case when policy_type = 'G' and  lpad(plan_code_v4 ,3 ,'0') between  '060' and '079' then 'I'
-- else policy_type end convert_policy_type 
,case_count
,data_source
,last_payment_v34
,birthdate_v21
,convert_birthdate_v21
,premium_amount_v1
,sex_v10
,age_at_comm_date_v11
,tmp_age_at_comm_date_v11
,maturity_date_v19a
,convert_maturity_date_v19a
,sum_assured_v3
,convert_sum_assured_v3
,payment_mode_v20
,convert_payment_mode
,plan_code_v4
,commencement_date_v5
,convert_commencement_date_v5
,prefix_name_v6b
,name_v6
,surname_v6a
,id_card_v33
,receipt_no_v27
,payment_final_v15
,move_date_v24
,fully_paid_date_v17
,next_payment_v32
,pay_from_v37
,pay_to_v39
,tranfer_type_v49
,delet_flag_v50
,request_no_v22
,tranfer_doc_no_v46
,tranfer_branch_v48
,refun_paid1_v42
,refun_date1_v42a
,refun_paid2_v43
,refun_date2_v43a
,refun_paid3_v44
,refun_date3_v44a
,loan_status_v02
,heard_org_v26
from temp_nbs_policy_master_ind 
where 1=1
) T1 
--temp_nbs_policy_master_ind T1
left join (
Select * from
(select row_number() over  (partition by policy_no_400 ,policy_type_400 order by priority , fully_paid_date_400 desc) as rownum, T2.*
from (

--Master ?????????: Industrial
select "mopol#" as policy_no_400 ,MOSTAS as policy_status_400 ,"mobr#" as branch_code_400 , MOLSTP as last_payment ,MOCSID  as custid  ,MOTITL as title_name_400 , MONAME :: varchar as name , MOSURN :: varchar as surname  ,null   as agentcode
, 'as400_ILISLIB_DEATHMO0' as data_source , 5 as priority
, moplan as plan_code_400 , mosex as sex_400 , moprem as premium_amount_400  ,null as payment_mode_400 , moperd as payment_term_400 , null as loan_status_400
,"morcp#" as receipt_no ,MOSINS  as sum_assured_400 ,MOCDTE as commencement_date_400 ,null as maturity_date_400 ,MOIAGE as age_at_comm_400
,null as last_update_date_400 ,MOPDTE as fully_paid_date_400 , 'I' :: varchar as policy_type_400
from as400_ILISLIB_DEATHMO0 
where "mopol#" is not NULL
union all
--Master ???????: Industrial
select "mrpol#" as policy_no_400 ,MRSTAS as policy_status_400 ,"mrbr#" as branch_code_400 , MRLSTP as last_payment ,MRCSID  as custid   ,MRTITL as title_name_400  , MRNAME :: varchar as name , MRSURN :: varchar as surname ,null as agentcode
, 'as400_ILISLIB_DECLNMR0' as data_source , 4 as priority
, mrplan as plan_code_400 , mrsex as sex_400 , mrprem as premium_amount_400  ,null as payment_mode_400, mrperd as payment_term_400  , null as loan_status_400
,"mrrcp#" as receipt_no ,MRSINS  as sum_assured_400 ,MRCDTE as commencement_date_400 ,null as maturity_date_400 ,MRIAGE as age_at_comm_400
,null as last_update_date_400 ,MRPDTE as fully_paid_date_400 , 'I' :: varchar as policy_type_400
from as400_ILISLIB_DECLNMR0 
where "mrpol#" is not NULL
union all
--Master ????????: Industrial
select "mppol#" as policy_no_400 ,MPSTAS as policy_status_400 ,"mpbr#" as branch_code_400 , MPLSTP as last_payment , null :: varchar as custid  ,MPTITL  as title_name_400 , MPNAME as name , MPSURN as surname ,null  as agentcode
, 'as400_ILISLIB_MATURMP0' as data_source , 3 as priority
, mpplan as plan_code_400 , mpsex as sex_400 , mpprem as premium_amount_400  ,null as payment_mode_400 ,mpperd as payment_term_400, mploan as loan_status_400
,"mprcp#" as receipt_no ,MPSINS  as sum_assured_400 ,MPCDTE as commencement_date_400 ,null as maturity_date_400 ,MPIAGE as age_at_comm_400
,null as last_update_date_400 ,MPPDTE as fully_paid_date_400 , 'I' :: varchar as policy_type_400
from as400_ILISLIB_MATURMP0 
where "mppol#" is not NULL
union all
--Master ????????: Industrial
select  "mrpol#" as policy_no_400 ,MRSTAS as policy_status_400 ,"mrbr#" as branch_code_400 , MRLSTP as last_payment, MRCSID  as custid  ,MRTITL as title_name_400  , MRNAME as name , MRSURN :: varchar as surname ,null  as agentcode 
, 'as400_ILISLIB_RETRNMR0' as data_source , 6 as priority
, mrplan as plan_code_400 , mrsex as sex_400 , mrprem as premium_amount_400  ,null as payment_mode_400 ,mrperd  as payment_term_400, null as loan_status_400
,"mrrcp#" as receipt_no ,MRSINS  as sum_assured_400 ,MRCDTE as commencement_date_400 ,null as maturity_date_400 ,MRIAGE as age_at_comm_400
,null as last_update_date_400 ,MRPDTE as fully_paid_date_400 , 'I' :: varchar as policy_type_400
from as400_ILISLIB_RETRNMR0 
where "mrpol#" is not NULL
union all
--Master Auto Surrender: Industrial
select "mapol#" as policy_no_400 , MASTAS as policy_status_400 ,"mabr#" as branch_code_400 , MALSTP as last_payment, null :: varchar as custid  ,matitl as title_name_400 , MANAME as name , MASURN as surname  ,null  as agentcode
, 'as400_ILISLIB_SURREMA0' as data_source , 7 as priority
, maplan as plan_code_400 , masex as sex_400 , maprem as premium_amount_400  ,null as payment_mode_400 ,maperd as payment_term_400 , maloan as loan_status_400
,"marcp#" as receipt_no ,MASINS  as sum_assured_400 ,MACDTE as commencement_date_400 ,null as maturity_date_400 ,MAIAGE as age_at_comm_400
,null as last_update_date_400 ,MAPDTE as fully_paid_date_400 , 'I' :: varchar as policy_type_400
from as400_ILISLIB_SURREMA0 
where "mapol#" is not NULL
union all
--Master Surrender: Industrial
select "mnpol#" as policy_no_400 , MNSTAS as policy_status_400  ,"mnbr#" as branch_code_400 , MNLSTP as last_payment, null  as custid  ,MNTITL as title_name_400 , MNNAME as name , MNSURN  as surname  ,null  as agentcode
, 'as400_ILISLIB_SURREMN0' as data_source , 8 as priority
, mnplan as plan_code_400 , mnsex as sex_400 , mnprem as premium_amount_400  ,null as payment_mode_400 ,mnperd as payment_term_400, mnloan as loan_status_400
,"mnrcp#" as receipt_no ,MNSINS  as sum_assured_400 ,MNCDTE as commencement_date_400 ,null as maturity_date_400 ,MNIAGE as age_at_comm_400
,null as last_update_date_400 ,MNPDTE as fully_paid_date_400, 'I' :: varchar as policy_type_400
from as400_ILISLIB_SURREMN0 
where "mnpol#"  is not NULL


) T2
) T2 
) T2 on (T1.policy_no_v2 = T2.policy_no_400 and T1.policy_type = T2.policy_type_400
              and T2.rownum = 1)
			  
left join (select T1.a1 as agent_agent5_master
,T1._branchcode as agent_branch_code_master
,T1.a19 as agent_agent7_master
,T1.a5 as agent_name_master
,T1.a7a as agent_position
,T1.a71 as agent5_next_level
,case when T1.a7a = '9' then T2.a1 else T1.a1 end agent_agent5
,case when T1.a7a = '9' then T2.a19 else T1.a19 end agent_agent7
,case when T1.a7a = '9' then T2._branchcode else  T1._branchcode end agent_branch_code
,case when T1.a7a = '9' then T2.a5 else T1.a5 end agent_agent_name
from agentid T1 left join agentid T2 on (COALESCE(T1.a71,'') = COALESCE(T2.a1) and COALESCE(T1._branchcode,'') = COALESCE(T2._branchcode,'') )
) T3 on ( T3.agent_branch_code_master =  T1.branch_code and T3.agent_agent5_master = T1.agent5_last5filename)
left join  as400_ilislib_custmmc0 T4 on (T2.custid = T4.mccsid )
where 1=1
and T1.policy_type = 'I' 
) T1
where   tmp_group_policy_status = 'Active' and Group_status = 'Inactive' 
--tmp_group_policy_status = 'Active' and Group_status = 'Inactive'
group by  T1.policy_type ,tmp_group_policy_status , Group_status

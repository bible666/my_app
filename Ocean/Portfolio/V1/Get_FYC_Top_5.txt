APUI04_03_Get_FYC_Top_5
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Feb 08, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล FYC Top 5 ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล FYC Top 5 ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
Icon
select	*
from		(
select	manager_name, manager_code_7, commission_first, 
		position_group, 
		position
from		(
			select	manager_code_7, manager_name, position_group, position, flag, commission_first,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, manager_code_7) as row_number
			from		(
						select	manager_code_7, manager_name,  
								'ผจก.หน่วย' :: varchar as position_group, 
								'ผู้จัดการหน่วย' :: varchar as position,
								case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
									else 1
								end	flag,
								sum(commission_first) as commission_first
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	headmn_code_7 = v_agent_code
							and	(manager_code_7 is not null and manager_code_7 <> '')
						group by	manager_code_7, manager_name,
								case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
									else 1
								end
						union all
						select	asst_manager_code_7 as manager_code_7, asst_manager_name as manager_name,  
								'ผช.ผจก.หน่วย' :: varchar as position_group, 
								'ผู้ช่วยผู้จัดการหน่วย' :: varchar as position,
								1 as flag,
								sum(commission_first) as commission_first
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	headmn_code_7 = v_agent_code
							and	((manager_code_7 is null or manager_code_7 = '') and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
						group by	asst_manager_code_7, asst_manager_name
					) aa		
		) bb
where	bb.row_number <= 5	
union all
select	'คนอื่นๆ รวมกัน' :: varchar as manager_name,
		null as manager_code_7,
		sum(commission_first) as commission_first, 
		null as position_group, null as position
from		(
			select	manager_code_7, manager_name, position_group, position, flag, commission_first,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, manager_code_7) as row_number
			from		(
						select	manager_code_7, manager_name,  
								'ผจก.หน่วย' :: varchar as position_group, 
								'ผู้จัดการหน่วย' :: varchar as position,
								case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
									else 1
								end	flag,
								sum(commission_first) as commission_first
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	headmn_code_7 = v_agent_code
							and	(manager_code_7 is not null and manager_code_7 <> '')
						group by	manager_code_7, manager_name,
								case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
									else 1
								end
						union all
						select	asst_manager_code_7 as manager_code_7, asst_manager_name as manager_name,  
								'ผช.ผจก.หน่วย' :: varchar as position_group, 
								'ผู้ช่วยผู้จัดการหน่วย' :: varchar as position,
								1 as flag,
								sum(commission_first) as commission_first
						from		agpt_agent_income
						where	period = v_period
							and	branch_code = v_branch_code
							and	headmn_code_7 = v_agent_code
							and	((manager_code_7 is null or manager_code_7 = '') and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
						group by	asst_manager_code_7, asst_manager_name
					) aa		
		) bb
where	bb.row_number > 5
) cc
where	cc.commission_first is not null;
     

 [SQL Not Used : Old Version]
     

[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
select	*
from
(
select	agent_name, agent_code_7, commission_first,
		case when position_group not in ('ผช.ผจก.หน่วย', 'หนน.', 'ตท.', 'ตท.กง.') then 'หนน.' :: varchar
			else position_group
		end position_group,
		case when position_group not in ('ผช.ผจก.หน่วย', 'หนน.', 'ตท.', 'ตท.กง.') then 'หัวหน้าหน่วย' :: varchar
			else position
		end as position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,
								c.position_group, c.position 
						from		(				
						 			select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as sub_commission_first,
						 					a.position_group, a.position
									from		agpt_agent_income a
									left outer join	agpt_agent_income b
									on		(a.period = b.period and a.branch_code = b.branch_code and
											 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
											(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))					
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.manager_code_7 = v_agent_code
										and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)
										and	(a.asst_manager_code_7 is null or a.asst_manager_code_7 = '')
									group by	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position
									union all -- Manager --> Agent (not have supervisor)
									select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_commission_first,
											a.position_group, a.position
									from		agpt_agent_income a
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.manager_code_7 = v_agent_code
										and	((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and 
											(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))
										and	(asst_manager_code_7 is null or asst_manager_code_7 = '')	
									union all
									select	asst_manager_code_7 as agent_code_7, asst_manager_name as agent_name, 
											null as recruiter_code_7, sum(commission_first) as commission_first, 0 as sub_commission_first,
											'ผช.ผจก.หน่วย' :: varchar as position_group, 'ผู้ช่วยผู้จัดการหน่วย' :: varchar as position
									from		agpt_agent_income
									where	period = v_period 
										and	branch_code = v_branch_code
										and	manager_code_7 = v_agent_code
										and	(manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
									group by	asst_manager_code_7, asst_manager_name
								) c
					) aa		
		) bb
where	bb.row_number <= 5	
union all
select	'คนอื่นๆ รวมกัน' :: varchar as manager_name,
		null as manager_code_7,
		sum(commission_first) as commission_first, 
		null as position_group, null as position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,
								c.position_group, c.position 
						from		(				
						 			select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as sub_commission_first,
						 					a.position_group, a.position
									from		agpt_agent_income a
									left outer join	agpt_agent_income b
									on		(a.period = b.period and a.branch_code = b.branch_code and
											 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
											(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))					
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.manager_code_7 = v_agent_code
										and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)
										and	(a.asst_manager_code_7 is null or a.asst_manager_code_7 = '')
									group by	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position
									union all -- Manager --> Agent (not have supervisor)
									select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_commission_first,
											a.position_group, a.position
									from		agpt_agent_income a
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.manager_code_7 = v_agent_code
										and	((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and 
											(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))
										and	(asst_manager_code_7 is null or asst_manager_code_7 = '')	
									union all
									select	asst_manager_code_7 as agent_code_7, asst_manager_name as agent_name, 
											null as recruiter_code_7, sum(commission_first) as commission_first, 0 as sub_commission_first,
											'ผช.ผจก.หน่วย' :: varchar as position_group, 'ผู้ช่วยผู้จัดการหน่วย' :: varchar as position
									from		agpt_agent_income
									where	period = v_period 
										and	branch_code = v_branch_code
										and	manager_code_7 = v_agent_code
										and	(manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
									group by	asst_manager_code_7, asst_manager_name
								) c
					) aa				
		) bb
where	bb.row_number > 5
) cc
where	cc.commission_first is not null;
     

 [SQL Not Used : Old Version]
     

[Phase 2 - add] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
select	*
from
(
select	agent_name, agent_code_7, commission_first,
		case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หนน.' :: varchar
			else position_group
		end position_group,
		case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หัวหน้าหน่วย' :: varchar
			else position
		end as position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,
								c.position_group, c.position 
						from		(				
						 			select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as sub_commission_first,
						 					a.position_group, a.position
									from		agpt_agent_income a
									left outer join	agpt_agent_income b
									on		(a.period = b.period and a.branch_code = b.branch_code and
											 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
											(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))					
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.asst_manager_code_7 = v_agent_code
										and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)
									group by	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position
									union all -- Manager --> Agent (not have supervisor)
									select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_premium_portfolio,
											a.position_group, a.position
									from		agpt_agent_income a
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.asst_manager_code_7 = v_agent_code
										and	((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and 
											(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))
								) c
					) aa		
		) bb
where	bb.row_number <= 5	
union all
select	'คนอื่นๆ รวมกัน' :: varchar as manager_name,
		null as asst_manager_code_7,
		sum(commission_first) as commission_first, 
		null as position_group, null as position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,
								c.position_group, c.position 
						from		(				
						 			select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as sub_commission_first,
						 					a.position_group, a.position
									from		agpt_agent_income a
									left outer join	agpt_agent_income b
									on		(a.period = b.period and a.branch_code = b.branch_code and
											 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
											(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))					
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.asst_manager_code_7 = v_agent_code
										and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)
									group by	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position
									union all -- Manager --> Agent (not have supervisor)
									select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_premium_portfolio,
											a.position_group, a.position
									from		agpt_agent_income a
									where	a.period = v_period
										and	a.branch_code = v_branch_code
										and	a.asst_manager_code_7 = v_agent_code
										and	((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and 
											(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))
								) c
					) aa			
		) bb
where	bb.row_number > 5
) cc
where	cc.commission_first is not null;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
select	*
from
(
select	agent_name, agent_code_7, commission_first,
		position_group, position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first,
								a.position_group, a.position
						from		agpt_agent_income a
						where	a.period = v_period
							and	a.branch_code = v_branch_code
							and	a.recruiter_code_7 = v_agent_code
							and	(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.')								
					) aa		
		) bb
where	bb.row_number <= 5
union all
select	'คนอื่นๆ รวมกัน' :: varchar as agent_name, 
		null as agent_code_7, 
		sum(commission_first) as commission_first,
		null as position_group, null as position
from		(
			select	agent_code_7, agent_name, commission_first, position_group, position,
					ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number
			from		(
						select	a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first,
								a.position_group, a.position
						from		agpt_agent_income a
						where	a.period = v_period
							and	a.branch_code = v_branch_code
							and	a.recruiter_code_7 = v_agent_code
							and	(a.position_group = 'ตท.' or a.position_group = 'ตท.กง.')								
					) aa		
		) bb
where	bb.row_number > 5
) cc
where	cc.commission_first is not null;
     

 [SQL Not Used : Old Version]
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group in ("ตท.", "ตท.กง.") อย่างใดอย่างหนึ่ง จะ return null
 

Post-conditions
ทำการ return ข้อมูล FYC Top 5 ทั้งหมด 5 fields คือ 
- agent_name
- agent_code_7
- commission_first
- position_group
- position
select  agent_name as agentName, agent_code_7 as agentCode7, commission_first as commissionFirst, position_group as positionGroup,position  
                     from  
                     (  
                     select agent_name, agent_code_7, commission_first,  
                            case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หนน.'   
                                else position_group  
                            end position_group,  
                            case when position_group not in ('หนน.', 'ตท.', 'ตท.กง.') then 'หัวหน้าหน่วย'   
                                else position  
                            end as position  
                     from       (  
                                select  agent_code_7, agent_name, commission_first, position_group, position,  
                                        ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number  
                                from        (  
                                            select  c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,  
                                                    c.position_group, c.position   
                                            from        (                 
                                                        select  a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as  sub_commission_first,  
                                                                a.position_group, a.position  
                                                        from        agpt_agent_income a  
                                                        left outer join agpt_agent_income b  
                                                        on      (a.period = b.period and a.branch_code = b.branch_code and  
                                                                 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and  
                                                                (b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))                    
                                                        where   a.period = :period  
                                                            and a.branch_code = :branchCode  
                                                            and a.asst_manager_code_7 = :agentCode  
                                                            and (a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)  
                                                        group by    a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position  
                                                        union all  
                                                        select  a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_premium_portfolio,  
                                                                a.position_group, a.position  
                                                        from        agpt_agent_income a  
                                                        where   a.period = :period  
                                                            and a.branch_code = :branchCode  
                                                            and a.asst_manager_code_7 = :agentCode  
                                                            and ((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and   
                                                                (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))  
                                                    ) c  
                                        ) aa          
                            ) bb  
                     where  bb.row_number <= 5     
                     union all  
                     select 'คนอื่นๆ รวมกัน'  as manager_name,  
                            null as asst_manager_code_7,  
                            sum(commission_first) as commission_first,   
                            null as position_group, null as position  
                     from       (  
                                select  agent_code_7, agent_name, commission_first, position_group, position,  
                                        ROW_NUMBER () OVER (ORDER BY commission_first desc, agent_code_7) as row_number  
                                from        (  
                                            select  c.agent_code_7, c.agent_name, c.recruiter_code_7, (c.commission_first + c.sub_commission_first) as commission_first,  
                                                    c.position_group, c.position   
                                            from        (                 
                                                        select  a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, sum(coalesce(b.commission_first,0)) as  sub_commission_first,  
                                                                a.position_group, a.position  
                                                        from        agpt_agent_income a  
                                                        left outer join agpt_agent_income b  
                                                        on      (a.period = b.period and a.branch_code = b.branch_code and  
                                                                 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and  
                                                                (b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))                    
                                                        where   a.period = :period  
                                                            and a.branch_code = :branchCode  
                                                            and a.asst_manager_code_7 = :agentCode  
                                                            and (a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null)  
                                                        group by    a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, a.position_group, a.position  
                                                        union all  
                                                        select  a.agent_code_7, a.agent_name, a.recruiter_code_7, a.commission_first, 0 as sub_premium_portfolio,  
                                                                a.position_group, a.position  
                                                        from        agpt_agent_income a  
                                                        where   a.period = :period  
                                                            and a.branch_code = :branchCode  
                                                            and a.asst_manager_code_7 = :agentCode  
                                                            and ((a.agent_code_7 = a.recruiter_code_7 or a.recruiter_code_7 is null or a.recruiter_code_7 = '') and   
                                                                (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null))  
                                                    ) c  
                                        ) aa              
                            ) bb  
                     where  bb.row_number > 5  
                     ) cc  
                     where  cc.commission_first is not null 
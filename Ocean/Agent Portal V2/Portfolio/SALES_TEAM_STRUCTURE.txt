SALES_TEAM_STRUCTURE
Skip to end of metadata
Added by วรัชญา สุขล้อม, last edited by ปาริฉัตร ปั้นหยา on Apr 23, 2020  (view change)Go to start of metadata
TABLE    SALES_TEAM_STRUCTURE
DESCRIPTION    ข้อมูลโครงสร้างตัวแทน
                                   Combine Phase 2
Field#    Description    Type    Size    Null(Y/N)    Key    Validation/Extra/Value    AS/400    
Web Service:

WS_AGT_03 ค้นหาข้อมูลโครงสร้างตัวแทนที่ Active ด้วยรหัสสาขา

WS_AGT_04 ค้นหาข้อมูลโครงสร้างตัวแทนที่ Inactive ด้วยรหัสสาขา

1    id    running number    int8    19    N    PK               
2    appointed_date    วันที่แต่งตั้ง    timestamptz    35    Y         
agentid:

ถ้าเป็นหัวหน้าหน่วย: a8, ถ้าเป็นตัวแทน: ww1

manage: mb

headmn: h04

lips.pspagtst.STRADT     structureAppointDate
3    branch_code    สาขา    varchar    4    Y         
agentid: abranch

manage: mbranch

headmn: hbranch

lips.pspagtms.BRNNO     branchCode
4    recruiter    
ผู้แต่งตั้ง

int8    19    Y         
AgentID: a7

และไปหา id ของ ตาราง sale_structure ที่มี กreference_code = a7 และต่อด้วย :00 (หัวหน้าหน่วย) และเอา id ที่หาได้มาใส่ใน field recruiter

Manage: mc ซึ่งเป็น code 2 หลัก โดยต้องเอา code 2 หลักและใส่ 0 สามตัว เช่น 08 ต้องไปหารหัสผู้แต่งตั้งโดย ผู้แต่งตั้งจะมีรหัส 08000

และไปหา id ของ ตาราง sale_structure ที่มี reference_code = 08000 และเอา id ที่หาได้มาใส่ใน field recruiter

HeadMn: h06

และไปหา id ของ ตาราง sale_structure ที่มี reference_code = h06 และเอา id ที่หาได้มาใส่ใน field recruiter

lips.pspagtst.STRREC,lips.pspagtst.STRBEL

หาผู้แต่งตั้งโดย lips.pspagtst.STRNUM ของผู้แต่งตั้ง = lips.pspagtst.STRREC ของผู้ถูกแต่งตั้ง
นำ lips.pspagtst.STRCOD ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี
sales_team_structure.reference_code = lips.pspagtst.STRCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field recruiter

กรณีที่เป็น ตำแหน่ง ตัวแทน (lips.pspagtst.POSCOD = '33','16')
หาผู้แต่งตั้งโดย lips.pspagtst.STRNUM ของผู้แต่งตั้ง = lips.pspagtst.STRBEL ของผู้ถูกแต่งตั้ง
นำ lips.pspagtms.AGENT7 ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี sales_team_structure .sales_code =  lips.pspagtms.AGENT7 และ sales_team_structure.position = lips.pspagtst.POSCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field recruiter
กรณีที่ไม่เป็น ตำแหน่ง ตัวแทน (tst.posgrp <> '33','16')
หาผู้แต่งตั้งโดย lips.pspagtst.STRNUM ของผู้แต่งตั้ง = lips.pspagtst.STRREC ของผู้ถูกแต่งตั้ง
นำ lips.pspagtms.AGENT7 ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี sales_team_structure .sales_code =  lips.pspagtms.AGENT7 และ sales_team_structure.position = lips.pspagtst.POSCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field recruiter

จาก structureRecruiter,structureBelong
หาผู้แต่งตั้งโดย
กรณีที่เป็นตำแหน่งตัวแทนและ ผู้ช่วยผู้จัดการหน่วย ให้ structureBelong ของผู้ถูกแต่งตั้ง = structureId ของผู้แต่งตั้ง
กรณีที่ไม่ใช่ ตำแหน่งตัวแทนและ ผู้ช่วยผู้จัดการหน่วย ให้ structureRecruiter ของผู้ถูกแต่งตั้ง = structureId ของผู้แต่งตั้ง
นำ structureCode ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี sales_team_structure.reference_code = structureCode
นำ agentCode และ positionCode ของผู้แต่งตั้ง ไปหา sales_team_structure ดังนี้
agentCode = sales_team_structure .sales_code
 positionCode = position (แต่ต้องนำ positionCode ไปหา position_id ที่ตาราง POSITION_MAPPING )
เอา sales_team_structure.id ที่หาได้มาใส่ใน field recruiter
 

5    reference_code         varchar    255    Y         
agentid: a1+"-"+a2

manage: ma1

headmn: h01

ถ้าเป็นตัวแทน lips.pspagtst.STRCOD+"-00"

ถ้าเป็นอื่นๆ lips.pspagtst.STRCOD

-- Update 30/07/62

ตัดการใช้ field lips.pspagtst.STRCOD เป็น Gen รหัส 5 หลักของ income ดังนี้

หาคนที่ตำแหน่งสูงสุดเป็นระดับภาคขาย tst.posgrp = 'HEADMN' ให้บันทึก Field reference_code ดังนี้
บันทึกรหัส 4 หลัก โดยเริ่มที่ 0001 ของแต่ละสาขา และ run เลข ไปเรื่อยๆ เช่น 0001,0002,0003 โดยจะบันทึกเฉพาะรายการที่ tst.posgrp = 'HEADMN'
หาคนที่ตำแหน่งสูงสุดเป็นกลุ่ม ผู้จัดการ tst.posgrp= 'MANAGER' (ตำแหน่งผู้จัดการ และ ตำแหน่ง ผู้ช่วยผู้จัดการ) ให้บันทึก Field reference_code ดังนี้
บันทึกรหัส 5 หลัก โดยเริ่มที่ 01000 ของแต่ละสาขา และ run เลข ไปเรื่อยๆ เช่น 01000 ,02000 ,03000 โดยจะบันทึกเฉพาะรายการที่ tst.posgrp= 'MANAGER'
หาคนที่อยู่ใต้สังกัดของผู้จัดการคนนี้ pspagtst.STRBEL = pspagtst.STRNUM ของผู้จัดการ (tst.posgrp= 'MANAGER') ให้บันทึก Field reference_code ดังนี้
กรณีที่คนที่อยู่ใต้ผู้จัดการ เป็นบัญชีแฝงของผู้จัดการ ให้บันทึกรหัส 5 หลัก โดยใช้ 2 หลักแรกของรายการ MANAGER จากข้อ a และ run 3 หลักสุดท้าย เป็น 001 เช่น manager ในข้อ a คือ 01000 ก็จะบันทึกเป็น 01001
บันทึกรหัส 5 หลัก โดยใช้ 2 หลักแรกของรายการ MANAGER จากข้อ a และ run 3 หลักสุดท้ายต่อไปเรื่อยๆ โดยจะเริ่ม 3 หลักสุดท้ายที่ 002 เช่น manager ในข้อ a คือ 01000 ก็เริ่มที่ 01002,01003
หาคนที่ตำแหน่งสูงสุดเป็นกลุ่มผู้จัดการสำนักงาน tst.posgrp = 'OFFICEADMIN' ให้บันทึก Field reference_code ดังนี้
บันทึกรหัส3หลัก โดยเริ่มที่ 001 ของแต่ละสาขา และ run เลข ไปเรื่อยๆ
 

ถ้าเป็นตัวแทน structureCode+"-00"

 

ถ้าเป็นอื่นๆ structureCode



6    report_to    สังกัด    int8    19    Y         
AgentID: เอา 2 หลัก ของ a1 มาเทียบกับ รหัสผู้จัดการ ma1

Manage: mab

และไปหา id ของ ตาราง sale_structure ที่มี reference_code = mab

lips.pspagtst.STRBEL

หาโดย lips.pspagtst.STRNUM ของต้นสังกัด = lips.pspagtst.STRBEL ของตัวแทน
นำ lips.pspagtst.STRCOD ของต้นสังกัด ไปหา sales_team_structure.id ที่มี reference_code = lips.pspagtst.STRCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to

กรณีที่เป็น ตำแหน่ง ตัวแทน และ ผู้ช่วยผู้จัดการ (lips.pspagtst.POSCOD = '33','16','67')
กรณีที่เป็นตำแหน่งผู้ช่วยผู้จัดการ (ุ67)
ถ้า lips.pspagtst.STRBEL เป็น HEAD ให้ใช้ lips.pspagtst.STRNUM ของต้นสังกัด = lips.pspagtst.STRBEL ของตัวแทน
ถ้าไม่ใช่ หาโดย lips.pspagtst.STRNUM ของต้นสังกัด = lips.pspagtst.STRBEL ของ report_to (lips.pspagtst.STRBEL ของ report_to หมายถึง  STRBEL ของ report_to ของตัวเอง)
นำ lips.pspagtms.AGENT7 ของต้นสังกัด ไปหา sales_team_structure.id ที่มี sales_team_structure .sales_code =  lips.pspagtms.AGENT7 และ sales_team_structure.position = lips.pspagtst.POSCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to
กรณีที่ไม่่เป็น ตำแหน่ง ตัวแทนและผู้ช่วยผู้จัดการ (lips.pspagtst.POSCOD <> '33','16','67')
หาโดย lips.pspagtst.STRNUM ของต้นสังกัด = lips.pspagtst.STRBEL ของตัวแทน
นำ lips.pspagtms.AGENT7 ของต้นสังกัด ไปหา sales_team_structure.id ที่มี sales_team_structure .sales_code =  lips.pspagtms.AGENT7 และ sales_team_structure.position = lips.pspagtst.POSCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to
 

กรณีที่เป็น ตำแหน่ง ผู้จัดการสำนักงาน (lips.pspagtst.POSCOD = '80')
บันทึกเป็น 0


 structureBelong
หาโดย structureBelong ของตัวแทน = structureId ของต้นสังกัด
นำ structureCode ของต้นสังกัด ไปหา sales_team_structure.id ที่มี sales_team_structure.reference_code = structureCode
นำ agentCode และ positionCode ของของต้นสังกัด ไปหา sales_team_structure ดังนี้
agentCode = sales_team_structure .sales_code
 positionCode = position (แต่ต้องนำ positionCode ไปหา position_id ที่ตาราง POSITION_MAPPING )
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to
กรณีที่เป็นตำแหน่ง ตัวแทนและ ผู้ช่วยผู้จัดการหน่วย ให้หา structureBelong ของ report_to อีกที
7    sales_code    รหัส สนญ.    varchar    255    Y         
agentid:

ถ้า a19 มีค่า ใช้ : a19 ,

ถ้า a19 ไม่มีค่า และตำแหน่งเป็นตัวแทน (a7a = 2) และ รหัส 5 หลัก(a1) มีค่าและไม่เท่ากับ รหัสผู้มอบอำนาจ (a1 != a71) ใช้ : a1+"BB"

manage: ma7

headmn: h08

lips.pspagtms.AGENT7    agentCode
8    position    ตำแหน่ง    int4    10    Y         
agentid: a7a

manage: ma

headmn: h03

lips.pspagtst.POSCOD

เทียบใน Table: POSITION_MAPPING ที่ 

position_mapping.position_code 

= lips.pspagtst.POSCOD

 

กรณีที่ tst.posgrp = 'OFFICEADMIN' ให้บันทึกเป็น 1



จาก positionCode

เทียบใน Table: POSITION_MAPPING 

ที่ position_mapping.position_code 

= positionCode 

จะได้ position_mapping.position_id

9    period    งวดผลงาน    varchar    10    Y         
คำนวนภายในระบบ

วันที่สั่งประมวลผล เทียบกับ TABLE PERIOD

      
10    
isactive

สถานะตัวแทน

false = ลาออก, true = ไม่ลาออก

boolean    1    Y         
agentid:a64

manage:ma33

headmn:h24

lips.pspagtst.STRPAT

positionActive
11    
change_income_period

งวดผลงานที่เปลี่ยนระบบรายได้

          Y         
manage =wws1
agentid = wws1

ไม่มีเรียกใช้แล้ว

default=Null

ไม่มีเรียกใช้แล้ว

default=Null

12    
system

ระบบ              Y         
headMn = wws (Mark * ระบบ2)

manage = wws ( N=ระบบใหม่งวด1558เป็นต้นไป,O=ระบบเก่าก่อนงวด1558)

agentid = wws2 (Mark * ระบบ2)

default = N    default = N
13    authority_id    ผู้มอบอำนาจ    int8    19    Y         
agentid: a71

lips.pspagtst.STRAID

หาโดย lips.pspagtst.STRNUM ของผู้มอบ = lips.pspagtst.STRAID ของตัวแทน
นำ lips.pspagtst.STRCOD ของผู้มอบ ไปหา sales_team_structure.id ที่มี reference_code = lips.pspagtst.STRCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field authority_id
structureAuthorityId
หาโดย structureAuthorityId ของตัวแทน = structureId ของผู้มอบ 
นำ structureCode ของผู้มอบ ไปหา sales_team_structure.id ที่มี sales_team_structure.reference_code = structureCode
นำ agentCode และ positionCode ของของต้นสังกัด ไปหา sales_team_structure ดังนี้
agentCode = sales_team_structure .sales_code
 positionCode = position (แต่ต้องนำ positionCode ไปหา position_id ที่ตาราง POSITION_MAPPING )
เอา sales_team_structure.id ที่หาได้มาใส่ใน field authority_id
14    full_name    ชื่อ-นามสกุล    varchar    255    Y         
agentid: a5

manage: ma2

headmn: h02

lips.pspagtms.AGTNAM + lips.pspagtms.AGTSNM    name+surname
15    appoint_day    วันที่กลับเข้าดำรงตำแหน่งตัวแทน    timestamptz    35    ํY         
agentid: appoint_day

lips.pspagtms.AGTRTN    returnDate
16    fa    เป็นตัวแทน FA    varchar    2    Y         
01 = ตัวแทน FA



จากไฟล์ agentid
ให้ดึงข้อมูลที่ agentid.ww4
 

ถ้าเป็นข้อมูลจากไฟล์ manage กับ headmn
ให้ไปดูที่ลูกในระดับ agentid ถ้า agentid.ww4 = 01 ก็ให้ fa = 01

ถ้า lips.pspagtms.AGTTYP = 01 มีค่าเป็น 01

กรณีอื่นๆ มีค่าเป็น Null

ถ้า agentType มีค่าเป็น 01

กรณีอื่นๆ มีค่าเป็น Null

17    paid_income    จ่ายรายได้ในระบบ Income    varchar    1    Y         
เป็นค่าว่างหรือ Y คือจ่ายรายได้ในระบบ Income Online



จากไฟล์ agentid

-ถ้าไม่ได้เป็นตัวแทน FA agentid.ww4 <> 01 ให้ paid_income = Y
-แต่ถ้าเป็นตัวแทน FA agentid.ww4 = 01
ให้ดูที่ agentid.income_online
ถ้า income_online = 1 ให้ paid_income = Y
  ถ้า income_online <> 1 ให้ paid_income = N



จากไฟล์ manage และ headmn

ให้ paid_income = Y

ถ้า lips.pspagtms.AGTINC = 1 มีค่าเป็น Y

กรณีอื่นๆ มีค่าเป็น N

 

กรณีที่

tst.posgrp = 'OFFICEADMIN' ให้บันทึกค่าเป็น N



ถ้า income = 1 มีค่าเป็น Y

กรณีอื่นๆ มีค่าเป็น N

 

กรณีที่

 

tst.posgrp = 'OFFICEADMIN' ให้บันทึกค่าเป็น N



18    report_to_manager    สังกัดผู้จัดการหน่วย    int8    19    Y         
กรณีเป็นผู้ช่วยผู้จัดการหน่วย

หาผู้จัดการหน่วยที่สังกัด โดยหาจาก รหัสผู้แต่งตั้ง manage.mc

ถ้ารหัสผู้แต่งตั้งที่พบ เป็นตำแหน่ง ผช.ผจน. manage.ma = 8 ให้นำรหัสผู้แต่งตั้งคนนั้นไปหาต่อ

กรณีเป็นผู้ช่วยผู้จัดการหน่วย

ถ้า sales_team_structure.report_to (สังกัด) เป็นผู้จัดหน่วย ให้มีค่าเท่ากับ sales_team_structure.report_to

ถ้าไม่ใช่ผู้จัดการหน่วยให้เป็น Null

lips.pspagtst.STRREC

lips.pspagtst.STRBEL

หา ผจน.ที่สังกัด จากผู้แต่งตั้งสังกัดโดย lips.pspagtst.STRREC lips.pspagtst.STRBEL ของผู้ช่วยผู้จัดการ = lips.pspagtst.STRNUM ของผู้แต่งตั้ง สังกัด
ถ้าสังกัดเป็น ผช.ผจน. ให้ไปหาสังกัดของคนนั้นต่อ
นำ lips.pspagtst.STRCOD ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี reference_code = lips.pspagtst.STRCOD ของผู้แต่งตั้ง
นำ lips.pspagtms.AGENT7 ของต้นสังกัด ไปหา sales_team_structure.id ที่มี sales_team_structure .sales_code =  lips.pspagtms.AGENT7 และ sales_team_structure.position = lips.pspagtst.POSCOD
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to_manager



กรณีเป็นผู้ช่วยผู้จัดการหน่วย

ถ้า sales_team_structure.report_to (สังกัด) เป็นผู้จัดหน่วย ให้มีค่าเท่ากับ sales_team_structure.report_to

ถ้าไม่ใช่ผู้จัดการหน่วยให้เป็น Null

จาก structureRecruiter structureBelong

หา ผจน.ที่สังกัด จากสังกัด โดย structureId ของผจน.ที่สังกัด = structureRecruiter structureBelong ของผู้ช่วยผู้จัดการหน่วย
ถ้าสังกัดเป็น ผช.ผจน. ให้ไปหาสังกัดของคนนั้นต่อ
นำ structureCode ของผู้แต่งตั้ง ไปหา sales_team_structure.id ที่มี sales_team_structure .reference_code = structureCode ของผู้แต่งตั้ง
นำ agentCode และ positionCode ของของต้นสังกัด ไปหา sales_team_structure ดังนี้
agentCode = sales_team_structure .sales_code
 positionCode = position (แต่ต้องนำ positionCode ไปหา position_id ที่ตาราง POSITION_MAPPING )
เอา sales_team_structure.id ที่หาได้มาใส่ใน field report_to_manager


19    level    
ระดับของตำแหน่งตัวแทน
A = หัวหน้าหน่วย A
B = หัวหน้าหน่วย B

varchar    5    Y         
agentid: sup_ab

ค่าว่าง = หัวหน้าหน่วย A
 B       = หัวหน้าหน่วย B

lips.pspagtst.POSCOD

กรณีที่ lips.pspagtst.POSCOD = 36 ให้มันทึกเป็น A
กรณีที่ lips.pspagtst.POSCOD = 38 ให้มันทึกเป็น B
กรณีที่ tst.posgrp = 'OFFICEADMIN' ให้บันทึกเป็น A
APUI12_04_Get_Inactive_Policy_Detail
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Apr 19, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล กธ.ขาดผล (ตามแต่ละระดับตำแหน่งที่เลือกมาจากหน้าจอ) และมี flag บอกว่า กธ. ใด เป็นของตนเอง กธ.ใดเป็นของลูกทีม ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล กธ.ขาดผล (ตามแต่ละระดับตำแหน่งที่เลือกมาจากหน้าจอ) และมี flag บอกว่า กธ. ใด เป็นของตนเอง กธ.ใดเป็นของลูกทีม ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." (รับค่านี้มาจาก drop down list) ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
Icon
select	a.supervisor_code_7 as agent_code, a.agent_code_7 as child_agent_code, a.agent_name as child_agent_name, 
		cast('Y' as varchar(1)) as myself_flag, 
		cast('N' as varchar(1)) as asst_flag,
		b.policy_type, a.policy_no, a.premium_status, a.plan_name, a.premium_month,
		a.paid_to_date, a.last_grace_period_date, a.commencement_date, a.la_name_surname
from		agpt_inactive_policy_detail a
left outer join	agpt_persistency_detail b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.supervisor_code_7 = b.supervisor_code_7
	and	a.policy_no = b.policy_no
where	a.period = v_period -- '2560/18'
	and	a.branch_code = v_branch_code -- '3208'
	and	a.supervisor_code_7 = v_agent_code -- '5711431'
order by	myself_flag desc, a.agent_code_7, b.policy_type, a.policy_no;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" (รับค่านี้มาจาก drop down list) ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
select	a.asst_manager_code_7 as agent_code, a.supervisor_code_7 as child_agent_code, a.supervisor_name as child_agent_name, 
		case
			when a.asst_manager_code_7 = a.supervisor_code_7 then cast('Y' as varchar(1))
			else cast('N' as varchar(1))
		end as myself_flag, 
		cast('N' as varchar(1)) as asst_flag,
		b.policy_type, a.policy_no, a.premium_status, a.plan_name, a.premium_month, 
		a.paid_to_date, a.last_grace_period_date, a.commencement_date, a.la_name_surname
from		agpt_inactive_policy_detail a
left outer join	agpt_persistency_detail b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.asst_manager_code_7 = b.asst_manager_code_7
	and	a.policy_no = b.policy_no
where	a.period = v_period -- '2560/18'
	and	a.branch_code = v_branch_code -- '3208'
	and	a.asst_manager_code_7 = v_agent_code -- '5711431'
order by	myself_flag desc, a.supervisor_code_7, b.policy_type, a.policy_no;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" (รับค่านี้มาจาก drop down list) ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
select	a.manager_code_7 as agent_code, a.supervisor_code_7 as child_agent_code, a.supervisor_name as child_agent_name, 
		case
			when a.manager_code_7 = a.supervisor_code_7 then cast('Y' as varchar(1))
			else cast('N' as varchar(1))
		end as myself_flag,
		case
			when (a.asst_manager_code_7 is not null and a.asst_manager_code_7 <> '') then cast('Y' as varchar(1))
			else cast('N' as varchar(1))
		end as asst_flag,
		b.policy_type, a.policy_no, a.premium_status, a.plan_name, a.premium_month, 
		a.paid_to_date, a.last_grace_period_date, a.commencement_date, a.la_name_surname
from		agpt_inactive_policy_detail a
left outer join	agpt_persistency_detail b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.manager_code_7 = b.manager_code_7
	and	a.policy_no = b.policy_no
where	a.period = v_period -- '2560/18'
	and	a.branch_code = v_branch_code -- '3208'
	and	a.manager_code_7 = v_agent_code -- '5711431'
order by	myself_flag desc, a.supervisor_code_7, b.policy_type, a.policy_no;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." (รับค่านี้มาจาก drop down list) ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
select	a.headmn_code_7 as agent_code, a.supervisor_code_7 as child_agent_code, a.supervisor_name as child_agent_name, 
		case
			when a.headmn_code_7 = a.supervisor_code_7 then cast('Y' as varchar(1))
			else cast('N' as varchar(1))
		end as myself_flag,
		cast('N' as varchar(1)) as asst_flag,
		b.policy_type, a.policy_no, a.premium_status, a.plan_name, a.premium_month, 
		a.paid_to_date, a.last_grace_period_date, a.commencement_date, a.la_name_surname
from		agpt_inactive_policy_detail a
left outer join	agpt_persistency_detail b
on		a.period = b.period
	and	a.branch_code = b.branch_code
	and	a.headmn_code_7 = b.headmn_code_7
	and	a.policy_no = b.policy_no
where	a.period = v_period -- '2560/18'
	and	a.branch_code = v_branch_code -- '3208'
	and	a.headmn_code_7 = v_agent_code -- '5711431'
order by	myself_flag desc, a.supervisor_code_7, b.policy_type, a.policy_no; 
     

ถ้าได้ค่าเป็น null ให้ return ค่าเป็น null

 

Post-conditions
ทำการ return ข้อมูล กธ.ขาดผล (ตามแต่ละระดับตำแหน่งที่เลือกมาจากหน้าจอ) ทั้งหมด 13 fields คือ 
- agent_code
- child_agent_code
- child_agent_name
- myself_flag
- asst_flag
- policy_type
- policy_no
- premium_status
- plan_name
- premium_month
- paid_to_date
- last_grace_period_date
- commencement_date
- la_name_surname

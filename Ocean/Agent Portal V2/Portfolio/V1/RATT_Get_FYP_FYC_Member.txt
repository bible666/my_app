APUI04_01_Get_FYP_FYC_Member
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Feb 08, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล FYP, FYC และ Member ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล FYP, FYC และ Member ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
ใช้รหัสตัวแทน 4001202 ใช้ในการทดสอบ
Icon
select	sum(aa.premium_portfolio) as fyp,
		sum(aa.commission_first) as fyc,
		sum(aa.flag + aa.flag_asst) as member, 
		sum(aa.new_case) as new_case, 
		sum(aa.new_case_ord_ind) as new_case_ord_ind,					-- >> [corrected by AGPT-78] 
		sum(aa.new_case_pa) as new_case_pa								-- >> [corrected by AGPT-78]
from		(		
			select	manager_name, 
					case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
						else 1
					end	flag,
					case when ((manager_code_7 is null or manager_code_7 = '') and (asst_manager_code_7 is not null and asst_manager_code_7 <> '')) then 1
						else 0
					end	flag_asst,
					sum(premium_portfolio) as premium_portfolio,
					sum(commission_first) as commission_first,
					sum(new_case_ord_ind + new_case_pa) as new_case,
					sum(new_case_ord_ind) as new_case_ord_ind,			-- >> [corrected by AGPT-78]
					sum(new_case_pa) as new_case_pa						-- >> [corrected by AGPT-78]
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	headmn_code_7 = v_agent_code
			group by	manager_name,
					case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
						else 1
					end,					
					case when ((manager_code_7 is null or manager_code_7 = '') and (asst_manager_code_7 is not null and asst_manager_code_7 <> '')) then 1
						else 0
					end	
		) aa;	
     

 [SQL Not Used : Old Version]
select	sum(aa.premium_portfolio) as fyp,
		sum(aa.commission_first) as fyc,
		sum(aa.flag) as member, 
		sum(aa.new_case) as new_case, 
		sum(aa.new_case_ord_ind) as new_case_ord_ind,					-- >> [corrected by AGPT-78] 
		sum(aa.new_case_pa) as new_case_pa								-- >> [corrected by AGPT-78]
from		(		
			select	manager_name, 
					case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
						else 1
					end	flag,
					sum(premium_portfolio) as premium_portfolio,
					sum(commission_first) as commission_first,
					sum(new_case_ord_ind + new_case_pa) as new_case,
					sum(new_case_ord_ind) as new_case_ord_ind,			-- >> [corrected by AGPT-78]
					sum(new_case_pa) as new_case_pa						-- >> [corrected by AGPT-78]
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	headmn_code_7 = v_agent_code
			group by	manager_name,
					case	when (manager_name like 'เขต%' or manager_name like 'ชำระเอง%' or manager_name is null) then 0
						else 1
					end	
		) aa;
     

[Phase 2 - edit] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
รหัสตัวแทนที่ใช้ทดสอบ 3100457, 3225506
select	aa.fyp,
		aa.fyc,
		sum(bb.flag) as member,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa
from		(
			select	sum(premium_portfolio) as fyp, sum(commission_first) as fyc,
					sum(new_case_ord_ind + new_case_pa) as new_case,
					sum(new_case_ord_ind) as new_case_ord_ind,
					sum(new_case_pa) as new_case_pa
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code	
			group by	period, branch_code, manager_code_7
		) aa,
		(		
			select	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end	flag
			from		agpt_agent_income a
			left outer join	agpt_agent_income b
			on		(a.period = b.period and a.branch_code = b.branch_code and
					 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
					(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))
			where	a.period = v_period
				and	a.branch_code = v_branch_code
				and	a.manager_code_7 = v_agent_code
				and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null) -- >> [corrected by AGPT-28] Start
				and	(a.asst_manager_code_7 is null or a.asst_manager_code_7 = '')
			group by	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end
			union all -- Manager --> Agent (not have supervisor)
			select	agent_name, 
					1 as	flag
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and 
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))        -- >> [corrected by AGPT-28] End
				and	(asst_manager_code_7 is null or asst_manager_code_7 = '')
			union all
			select	asst_manager_name, 
					1 as	flag
			from		agpt_agent_income
			where	period = v_period 
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	(manager_code_7 <> asst_manager_code_7 and (asst_manager_code_7 is not null and asst_manager_code_7 <> ''))
			group by	asst_manager_name
		) bb		
group by	aa.fyp,
		aa.fyc,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa;
     

 [SQL Not Used : Old Version]
select	aa.fyp,
		aa.fyc,
		sum(bb.flag) as member,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa
from		(
			select	sum(premium_portfolio) as fyp, sum(commission_first) as fyc,
					sum(new_case_ord_ind + new_case_pa) as new_case,
					sum(new_case_ord_ind) as new_case_ord_ind,
					sum(new_case_pa) as new_case_pa
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code	
			group by	period, branch_code, manager_code_7
		) aa,
		(		
			select	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end	flag
			from		agpt_agent_income a
			left outer join	agpt_agent_income b
			on		(a.period = b.period and a.branch_code = b.branch_code and
					 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
					(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))
			where	a.period = v_period
				and	a.branch_code = v_branch_code
				and	a.manager_code_7 = v_agent_code
				and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null) -- >> [corrected by AGPT-28] Start
			group by	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end
			union all -- Manager --> Agent (not have supervisor)
			select	agent_name, 
					1 as	flag
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and 
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))        -- >> [corrected by AGPT-28] End
		) bb		
group by	aa.fyp,
		aa.fyc,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa;
select	sum(aa.premium_portfolio + aa.sub_premium_portfolio) as fyp,
		sum(aa.commission_first + aa.sub_commission_first) as fyc,
		sum(aa.flag) as member, 
		sum(aa.new_case) as new_case, 
		sum(aa.new_case_ord_ind) as new_case_ord_ind,					-- >> [corrected by AGPT-78] 
		sum(aa.new_case_pa) as new_case_pa								-- >> [corrected by AGPT-78]
from		(		
			select	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end	flag,
					a.premium_portfolio, sum(coalesce(b.premium_portfolio,0)) as sub_premium_portfolio,
					a.commission_first, sum(coalesce(b.commission_first,0)) as sub_commission_first,
					(a.new_case_ord_ind + a.new_case_pa) as new_case,
					a.new_case_ord_ind,									-- >> [corrected by AGPT-78]
					a.new_case_pa										-- >> [corrected by AGPT-78]
			from		agpt_agent_income a
			left outer join	agpt_agent_income b
			on		(a.period = b.period and a.branch_code = b.branch_code and
					 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
					(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))
			where	a.period = v_period
				and	a.branch_code = v_branch_code
				and	a.manager_code_7 = v_agent_code
				and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null) -- >> [corrected by AGPT-28] Start
			group by	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end,
					a.premium_portfolio,
					a.commission_first,
					(a.new_case_ord_ind + a.new_case_pa),
					a.new_case_ord_ind,
					a.new_case_pa 
			union all -- Manager --> Agent (not have supervisor)
			select	agent_name, 
					1 as	flag,
					premium_portfolio, 0 as sub_premium_portfolio,
					commission_first, 0 as sub_commission_first,
					(new_case_ord_ind + new_case_pa) as new_case,
					new_case_ord_ind,									-- >> [corrected by AGPT-78]
					new_case_pa											-- >> [corrected by AGPT-78]
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and 
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))        -- >> [corrected by AGPT-28] End
		) aa;
     

[Phase 2 - add] ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
รหัสตัวแทนที่ใช้ตรวจสอบ 3100446, 5101725
select	aa.fyp,
		aa.fyc,
		sum(bb.flag) as member,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa
from		(
			select	sum(premium_portfolio) as fyp, sum(commission_first) as fyc,
					sum(new_case_ord_ind + new_case_pa) as new_case,
					sum(new_case_ord_ind) as new_case_ord_ind,
					sum(new_case_pa) as new_case_pa
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	asst_manager_code_7 = v_agent_code	
			group by	period, branch_code, asst_manager_code_7
		) aa,
		(		
			select	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end	flag
			from		agpt_agent_income a
			left outer join	agpt_agent_income b
			on		(a.period = b.period and a.branch_code = b.branch_code and
					 a.agent_code_7 = b.recruiter_code_7 and a.agent_code_7 <> b.agent_code_7 and
					(b.position_group = 'ตท.' or b.position_group = 'ตท.กง.' or b.position_group is null))
			where	a.period = v_period
				and	a.branch_code = v_branch_code
				and	a.asst_manager_code_7 = v_agent_code
				and	(a.position_group <> 'ตท.' and a.position_group <> 'ตท.กง.' and a.position_group is not null) -- >> [corrected by AGPT-28] Start
			group by	a.agent_name, 
					case	when (a.position_group = 'ตท.' or a.position_group = 'ตท.กง.' or a.position_group is null) then 0
						else 1
					end
			union all -- asst_manager --> Agent (not have supervisor)
			select	agent_name, 
					1 as	flag
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	asst_manager_code_7 = v_agent_code
				and	((agent_code_7 = recruiter_code_7 or recruiter_code_7 is null or recruiter_code_7 = '') and 
					(position_group = 'ตท.' or position_group = 'ตท.กง.' or position_group is null))        -- >> [corrected by AGPT-28] End
		) bb		
group by	aa.fyp,
		aa.fyc,
		aa.new_case,
		aa.new_case_ord_ind,
		aa.new_case_pa;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
รหัสตัวแทนที่ใช้ ตรวจสอบ 3001105
select	sum(aa.premium_portfolio) as fyp,
		sum(aa.commission_first) as fyc,
		sum(aa.flag) as member,
		sum(aa.new_case) as new_case,
		sum(aa.new_case_ord_ind) as new_case_ord_ind,					-- >> [corrected by AGPT-78]						
		sum(aa.new_case_pa) as new_case_pa								-- >> [corrected by AGPT-78]
from		(		
			select	agent_name, 
					0 as	flag,
					premium_portfolio,
					commission_first,
					(new_case_ord_ind + new_case_pa) as new_case,
					new_case_ord_ind,									-- >> [corrected by AGPT-78]
					new_case_pa,										-- >> [corrected by AGPT-78]
					position_group,
					position
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	agent_code_7 = v_agent_code
			union all
			select	agent_name, 
					1 as	flag,
					premium_portfolio,
					commission_first,
					(new_case_ord_ind + new_case_pa) as new_case,
					new_case_ord_ind,									-- >> [corrected by AGPT-78]
					new_case_pa,										-- >> [corrected by AGPT-78]
					position_group,
					position
			from		agpt_agent_income
			where	period = v_period
				and	branch_code = v_branch_code
				and	recruiter_code_7 = v_agent_code
				and	(position_group = 'ตท.' or position_group = 'ตท.กง.')
		) aa;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group in ("ตท.", "ตท.กง.") อย่างใดอย่างหนึ่ง ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 6.)
Icon
รหัสตัวแทนที่ใช้ทดสอบ 5500154
select	premium_portfolio as fyp,
		commission_first as fyc,
		0 as	member,
		(new_case_ord_ind + new_case_pa) as new_case,
		new_case_ord_ind,												-- >> [corrected by AGPT-78]
		new_case_pa														-- >> [corrected by AGPT-78]
from		agpt_agent_income
where	period = v_period
	and	branch_code = v_branch_code
	and	agent_code_7 = v_agent_code;
     

ถ้าได้ค่าเป็น null ให้ return ค่าเป็น
- fyp = 0.00
- fyc = 0.00
- member = 0

 

Post-conditions
ทำการ return ข้อมูล FYP, FYC และ Member ทั้งหมด 6 fields คือ 
- fyp
- fyc
- member
- new_case
- new_case_ord_ind
- new_case_pa

APUI10_01_Get_Persistency_Summary_by_Status
Skip to end of metadata
Added by วิรัตน์ มหาศาลประเสริฐ, last edited by วิรัตน์ มหาศาลประเสริฐ on Jun 04, 2018  (view change)Go to start of metadata
TOC

[ Objectives ] [ Process Overview ] [ Preconditions ] [ Process Description ] [ Post-conditions ]
Objectives
ดึงข้อมูล Persistency Summary แยกตามสถานะ (เบี้ยมีผล, เบี้ยขาดผล) ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Process Overview
ดึงข้อมูล Persistency Summary แยกตามสถานะ (เบี้ยมีผล, เบี้ยขาดผล) ในฐานข้อมูล ตาม agent code, branch_code, period และ position_group ที่ได้รับมา
 

Preconditions
รับค่า agent code, branch_code, period และ position_group เข้ามา
 

Process Description
ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจภ.สข." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 2.)
Icon
select	policy_type, count(policy_no) as count_policy, 
		sum(count_policy_active) as count_policy_active, sum(count_policy_inactive) as count_policy_inactive,
		sum(premium_target) as premium_target,
		sum(premium_target_active) as premium_target_active, sum(premium_target_inactive) as premium_target_inactive
from
(
select	policy_type, policy_no, 
		case when premium_status = 'เบี้ยมีผล' then 1 else 0 end as count_policy_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else 1 end as count_policy_inactive,
		premium_target,
		case when premium_status = 'เบี้ยมีผล' then premium_target else 0 end as premium_target_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else premium_target end as premium_target_inactive
from		agpt_persistency_detail a
where	period = v_period -- '2560/18'
	and	branch_code = v_branch_code -- '3208'
	and	headmn_code_7 = v_agent_code -- '3401793'
) aa	
group by	policy_type
order by	policy_type desc;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 3.) 
Icon
select	policy_type, count(policy_no) as count_policy, 
		sum(count_policy_active) as count_policy_active, sum(count_policy_inactive) as count_policy_inactive,
		sum(premium_target) as premium_target,
		sum(premium_target_active) as premium_target_active, sum(premium_target_inactive) as premium_target_inactive
from
(
select	policy_type, policy_no, 
		case when premium_status = 'เบี้ยมีผล' then 1 else 0 end as count_policy_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else 1 end as count_policy_inactive,
		premium_target,
		case when premium_status = 'เบี้ยมีผล' then premium_target else 0 end as premium_target_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else premium_target end as premium_target_inactive
from		agpt_persistency_detail a
where	period = v_period -- '2560/18'
	and	branch_code = v_branch_code -- '3208'
	and	manager_code_7 = v_agent_code -- '3401793'
) aa	
group by	policy_type
order by	policy_type desc;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "ผช.ผจก.หน่วย" ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 4.)
Icon
select	policy_type, count(policy_no) as count_policy, 
		sum(count_policy_active) as count_policy_active, sum(count_policy_inactive) as count_policy_inactive,
		sum(premium_target) as premium_target,
		sum(premium_target_active) as premium_target_active, sum(premium_target_inactive) as premium_target_inactive
from
(
select	policy_type, policy_no, 
		case when premium_status = 'เบี้ยมีผล' then 1 else 0 end as count_policy_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else 1 end as count_policy_inactive,
		premium_target,
		case when premium_status = 'เบี้ยมีผล' then premium_target else 0 end as premium_target_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else premium_target end as premium_target_inactive
from		agpt_persistency_detail a
where	period = v_period -- '2560/18'
	and	branch_code = v_branch_code -- '3208'
	and	asst_manager_code_7 = v_agent_code -- '3508459'
) aa	
group by	policy_type
order by	policy_type desc;
     

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group = "หนน." ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 5.)
Icon
select	policy_type, count(policy_no) as count_policy, 
		sum(count_policy_active) as count_policy_active, sum(count_policy_inactive) as count_policy_inactive,
		sum(premium_target) as premium_target,
		sum(premium_target_active) as premium_target_active, sum(premium_target_inactive) as premium_target_inactive
from
(
select	policy_type, policy_no, 
		case when premium_status = 'เบี้ยมีผล' then 1 else 0 end as count_policy_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else 1 end as count_policy_inactive,
		premium_target,
		case when premium_status = 'เบี้ยมีผล' then premium_target else 0 end as premium_target_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else premium_target end as premium_target_inactive
from		agpt_persistency_detail a
where	period = v_period -- '2560/18'
	and	branch_code = v_branch_code -- '3208'
	and	supervisor_code_7 = v_agent_code -- '3401793'
) aa	
group by	policy_type
order by	policy_type desc;
          

ถ้า agent code, branch_code และ period ที่ได้รับมานั้น มี position_group in ("ตท.", "ตท.กง.") อย่างใดอย่างหนึ่ง ให้ใช้ SQL ดังนี้ (ไม่ต้องทำต่อข้อ 6.)
Icon
select	policy_type, count(policy_no) as count_policy, 
		sum(count_policy_active) as count_policy_active, sum(count_policy_inactive) as count_policy_inactive,
		sum(premium_target) as premium_target,
		sum(premium_target_active) as premium_target_active, sum(premium_target_inactive) as premium_target_inactive
from
(
select	policy_type, policy_no, 
		case when premium_status = 'เบี้ยมีผล' then 1 else 0 end as count_policy_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else 1 end as count_policy_inactive,
		premium_target,
		case when premium_status = 'เบี้ยมีผล' then premium_target else 0 end as premium_target_active,
		case when premium_status = 'เบี้ยมีผล' then 0 else premium_target end as premium_target_inactive
from		agpt_persistency_detail a
where	period = v_period -- '2561/07'
	and	branch_code = v_branch_code -- '3406'
	and	(agent_code_7 = v_agent_code or supervisor_code_7 = v_agent_code) -- '3508111'
) aa	
group by	policy_type
order by	policy_type desc;
     

 [SQL Not Used : Old Version]
     

Post-conditions
ทำการ return ข้อมูล Persistency Summary ทั้งหมด 7 fields คือ 
- policy_type
- count_policy
- count_policy_active
- count_policy_inactive
- premium_target
- premium_target_active
- premium_target_inactive
LikeBe the first to like this